<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤©å¤©å‘ä¸Šå°æ¨‚åœ’</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, addDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // ç¢ºä¿åœ¨ Canvas ç’°å¢ƒä¸­ï¼Œé€™äº›å…¨åŸŸè®Šæ•¸æœƒè¢«è‡ªå‹•æä¾›
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : '';

        // å…¨åŸŸè®Šæ•¸ä»¥ä¾›å­˜å–
        window.app = initializeApp(firebaseConfig);
        window.auth = getAuth(app);
        window.db = getFirestore(app);
        window.userId = '';
        window.isAuthReady = false;

        // åœ¨æ‡‰ç”¨ç¨‹å¼å•Ÿå‹•æ™‚è™•ç†èªè­‰
        onAuthStateChanged(window.auth, async (user) => {
            if (user) {
                window.userId = user.uid;
                console.log("Firebase signed in. User ID:", window.userId);
            } else {
                console.log("No user signed in. Signing in anonymously.");
                try {
                    // å¦‚æœæ²’æœ‰åˆå§‹ä»¤ç‰Œï¼Œå‰‡åŒ¿åç™»å…¥
                    if (initialAuthToken) {
                        await signInWithCustomToken(window.auth, initialAuthToken);
                    } else {
                        await signInAnonymously(window.auth);
                    }
                    window.userId = window.auth.currentUser.uid;
                } catch (error) {
                    console.error("Firebase auth failed:", error);
                }
            }
            // èªè­‰å®Œæˆï¼Œå¯ä»¥é–‹å§‹åŸ·è¡Œ Firestore ç›¸é—œæ“ä½œ
            window.isAuthReady = true;
            document.dispatchEvent(new Event('auth-ready'));
        });
    </script>
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- SortableJS for drag-and-drop -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap');
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f0f4f8;
        }
        /* éš±è—æ—¥æ›†çš„é è¨­ç®­é ­ */
        input[type="date"]::-webkit-calendar-picker-indicator {
            opacity: 0;
            position: absolute;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        .task-card {
            touch-action: none;
            user-select: none;
        }
        /* æ‹–æ›³æ™‚çš„æ¨£å¼ */
        .sortable-ghost {
            opacity: 0.4;
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div id="app" class="max-w-6xl mx-auto bg-white rounded-3xl shadow-xl p-6 md:p-10">
        <!-- æ‡‰ç”¨ç¨‹å¼ä¸»ä»‹é¢ -->
        <div class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-bold text-blue-600 mb-2 drop-shadow-md">
                å¤©å¤©å‘ä¸Šå°æ¨‚åœ’
            </h1>
            <p id="appSubtitle" class="text-lg md:text-xl text-gray-500">
                çµ¦å°å°å­¸ç¿’è€…çš„å°ˆå±¬ä»»å‹™æ¿ï¼
            </p>
            <!-- é¡¯ç¤ºä½¿ç”¨è€…IDï¼Œæ–¹ä¾¿å¤šäººå…±ç”¨ -->
            <div id="userInfo" class="mt-4 text-sm text-gray-400">
                ä½¿ç”¨è€… ID: <span id="userIdDisplay">è¼‰å…¥ä¸­...</span>
            </div>
        </div>

        <!-- åŠŸèƒ½å€å¡Š -->
        <div class="flex flex-col md:flex-row items-center justify-between gap-4 mb-8">
            <!-- æ—¥æœŸé¸æ“‡å™¨ -->
            <div class="flex items-center gap-2 bg-purple-100 p-3 rounded-xl shadow-inner">
                <label for="datePicker" class="text-lg text-purple-800 font-bold">é¸æ“‡æ—¥æœŸ:</label>
                <input type="date" id="datePicker"
                       class="p-2 rounded-xl border-2 border-purple-300 focus:outline-none focus:border-purple-500 transition-colors duration-200">
            </div>
            
            <div class="flex flex-wrap items-center justify-center gap-4">
                <!-- ä¸Šå€‹æœˆç¸½çµæŒ‰éˆ• -->
                <button id="monthlySummaryBtn"
                        class="bg-yellow-500 text-white font-bold py-3 px-6 rounded-xl
                               shadow-lg hover:bg-yellow-600 transition-colors duration-200">
                    ä¸Šæœˆå®Œæˆç¸½çµ
                </button>
            </div>
        </div>

        <!-- ä»»å‹™è¼¸å…¥å€ -->
        <div class="bg-blue-100 p-6 rounded-2xl shadow-inner mb-8">
            <h2 class="text-2xl font-bold text-blue-800 mb-4">æ–°å¢ä»Šæ—¥ä»»å‹™</h2>
            <div class="flex flex-col sm:flex-row gap-4">
                <input type="text" id="taskInput" placeholder="ä¾‹å¦‚: é–±è®€æ•…äº‹æ›¸30åˆ†é˜"
                       class="flex-grow p-3 rounded-xl border-2 border-blue-300 focus:outline-none focus:border-blue-500 shadow-sm transition-colors duration-200">
                <button id="addTaskBtn"
                        class="bg-blue-500 text-white font-bold py-3 px-6 rounded-xl
                               shadow-lg hover:bg-blue-600 transition-colors duration-200">
                    æ–°å¢ä»»å‹™
                </button>
            </div>
        </div>

        <!-- ä»»å‹™åˆ—è¡¨å€ -->
        <div id="taskList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- ä»»å‹™å¡ç‰‡æœƒåœ¨é€™è£¡å‹•æ…‹ç”Ÿæˆ -->
        </div>

        <!-- è¨Šæ¯èˆ‡çå‹µå€ -->
        <div id="messageBox" class="mt-8 bg-green-100 p-6 rounded-2xl shadow-md text-center hidden">
            <p id="messageText" class="text-xl md:text-2xl font-bold text-green-700 mb-2">
                å¤ªæ£’äº†ï¼ä½ åˆå®Œæˆäº†ä¸€é …ä»»å‹™ï¼
            </p>
            <p id="starCount" class="text-3xl font-extrabold text-yellow-500">
                â­ ç¸½è¨ˆ: 0
            </p>
        </div>
    </div>

    <!-- è¼‰å…¥ä¸­çš„æç¤ºèˆ‡ Modal -->
    <div id="loadingOverlay" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white p-6 rounded-xl shadow-lg flex items-center space-x-3">
            <div class="animate-spin rounded-full h-8 w-8 border-4 border-t-blue-500 border-gray-200"></div>
            <span class="text-lg text-gray-700 font-medium">AI åŠ©æ‰‹æ­£åœ¨åŠªåŠ›æ€è€ƒä¸­...</span>
        </div>
    </div>

    <!-- ç·¨è¼¯ä»»å‹™çš„ Modal -->
    <div id="editModal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white p-8 rounded-3xl shadow-xl w-11/12 md:w-1/2">
            <h3 class="text-2xl font-bold text-blue-600 mb-4">ç·¨è¼¯ä»»å‹™</h3>
            <input type="text" id="editTaskInput" class="w-full p-3 rounded-xl border-2 border-blue-300 focus:outline-none focus:border-blue-500 shadow-sm transition-colors duration-200 mb-4">
            <div class="flex justify-end gap-4">
                <button id="saveEditBtn" class="bg-green-500 text-white font-bold py-2 px-4 rounded-xl shadow-md hover:bg-green-600 transition-colors duration-200">
                    å„²å­˜
                </button>
                <button id="cancelEditBtn" class="bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-xl shadow-md hover:bg-gray-400 transition-colors duration-200">
                    å–æ¶ˆ
                </button>
            </div>
        </div>
    </div>
    
    <!-- ç¸½çµ Modal -->
    <div id="summaryModal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white p-8 rounded-3xl shadow-xl w-11/12 md:w-2/3">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold text-blue-600">ä¸Šæœˆå®Œæˆä»»å‹™ç¸½çµ</h3>
                <button id="closeSummaryBtn" class="text-gray-500 hover:text-gray-700 text-2xl">
                    &times;
                </button>
            </div>
            <div id="summaryContent" class="prose max-w-none text-gray-700">
                <!-- AI ç”Ÿæˆçš„ç¸½çµå…§å®¹æœƒåœ¨é€™è£¡ -->
                <p>è¼‰å…¥ä¸­...</p>
            </div>
        </div>
    </div>

    <script type="module">
        // æˆ‘å·²å°‡ `query` å’Œ `where` æ–°å¢åˆ°é€™è£¡ï¼Œä»¥ä¾¿åœ¨æ‡‰ç”¨ç¨‹å¼é‚è¼¯ä¸­ä½¿ç”¨
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, getDocs, updateDoc, deleteDoc, query, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // å…¨åŸŸè®Šæ•¸ï¼Œç¢ºä¿åœ¨èªè­‰å®Œæˆå¾Œæ‰ä½¿ç”¨
        let db, auth, userId;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // å–å¾— DOM å…ƒç´ 
        const userIdDisplay = document.getElementById('userIdDisplay');
        const datePicker = document.getElementById('datePicker');
        const taskInput = document.getElementById('taskInput');
        const addTaskBtn = document.getElementById('addTaskBtn');
        const taskList = document.getElementById('taskList');
        const messageBox = document.getElementById('messageBox');
        const messageText = document.getElementById('messageText');
        const starCountElement = document.getElementById('starCount');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const editModal = document.getElementById('editModal');
        const editTaskInput = document.getElementById('editTaskInput');
        const saveEditBtn = document.getElementById('saveEditBtn');
        const cancelEditBtn = document.getElementById('cancelEditBtn');
        const monthlySummaryBtn = document.getElementById('monthlySummaryBtn');
        const summaryModal = document.getElementById('summaryModal');
        const summaryContent = document.getElementById('summaryContent');
        const closeSummaryBtn = document.getElementById('closeSummaryBtn');

        // åˆå§‹åŒ–è®Šæ•¸
        let tasks = [];
        let stars = 0;
        let selectedDate = new Date().toISOString().split('T')[0];
        let editingTaskId = null;

        // API ç›¸é—œ
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${""}`;
        const apiCache = {};
        let retries = 0;
        const maxRetries = 3;
        const baseDelay = 1000;

        // å»¶é²åŸ·è¡Œï¼Œç›´åˆ° Firebase èªè­‰å®Œæˆ
        document.addEventListener('auth-ready', () => {
            db = window.db;
            auth = window.auth;
            userId = window.userId;
            userIdDisplay.textContent = userId;
            
            // åˆå§‹åŒ–æ—¥æ›†
            datePicker.value = selectedDate;
            datePicker.addEventListener('change', (e) => {
                selectedDate = e.target.value;
                listenForTasks();
            });

            // é–‹å§‹ç›£è½ Firestore çš„ä»»å‹™
            listenForTasks();
        });

        // å‘¼å« Gemini API
        async function getGeminiResponse(prompt) {
            if (apiCache[prompt]) return apiCache[prompt];

            loadingOverlay.classList.remove('hidden');

            try {
                const payload = {
                    contents: [{ parts: [{ text: prompt }] }]
                };
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error(`API error: ${response.status} ${response.statusText}`);

                const result = await response.json();
                const text = result?.candidates?.[0]?.content?.parts?.[0]?.text || 'ç„¡æ³•ç”Ÿæˆå›æ‡‰ã€‚';
                
                apiCache[prompt] = text;
                loadingOverlay.classList.add('hidden');
                return text;
            } catch (error) {
                loadingOverlay.classList.add('hidden');
                console.error('API å‘¼å«å¤±æ•—:', error);
                if (retries < maxRetries) {
                    retries++;
                    const delay = baseDelay * Math.pow(2, retries);
                    await new Promise(resolve => setTimeout(resolve, delay));
                    return getGeminiResponse(prompt);
                }
                return 'ç›®å‰ç„¡æ³•å–å¾—AIå”åŠ©ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚';
            }
        }

        // ç›£è½ Firestore çš„ä»»å‹™åˆ—è¡¨
        function listenForTasks() {
            if (!db || !userId || !selectedDate) return;
            const tasksCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/tasks`);
            // ç¾åœ¨ query å’Œ where å·²ç¶“è¢«æ­£ç¢ºåŒ¯å…¥ï¼Œæ‰€ä»¥ä¸æœƒå†å ±éŒ¯
            const q = query(tasksCollectionRef, where("date", "==", selectedDate));
            onSnapshot(q, (snapshot) => {
                tasks = [];
                let completedTasks = 0;
                snapshot.forEach(doc => {
                    const task = { id: doc.id, ...doc.data() };
                    tasks.push(task);
                    if (task.completed) completedTasks++;
                });
                renderTasks();
                stars = completedTasks;
                starCountElement.textContent = `â­ ç¸½è¨ˆ: ${stars}`;
            }, (error) => {
                console.error("Error fetching tasks:", error);
                taskList.innerHTML = `<p class="text-center text-red-500 col-span-full">è¼‰å…¥ä»»å‹™å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šã€‚</p>`;
            });
        }

        // æ¸²æŸ“ä»»å‹™åˆ—è¡¨
        function renderTasks() {
            taskList.innerHTML = '';
            if (tasks.length === 0) {
                taskList.innerHTML = `<p class="text-center text-gray-400 col-span-full">é€™å¤©é‚„æ²’æœ‰ä»»å‹™å–”ï¼Œå¿«ä¾†æ–°å¢å§ï¼</p>`;
            }
            
            // æ ¹æ“š tasks é™£åˆ—çš„é †åºä¾†æ¸²æŸ“
            tasks.sort((a, b) => (a.order || 0) - (b.order || 0)).forEach(task => {
                const taskCard = document.createElement('div');
                taskCard.className = `task-card bg-white p-5 rounded-2xl shadow-md transition-all duration-300 transform hover:scale-105 relative border-2 border-gray-200 ${task.completed ? 'opacity-60 bg-green-50 border-green-400' : ''}`;
                taskCard.dataset.id = task.id;

                let content = `<p class="text-lg font-medium text-gray-700 mb-4">${task.text}</p>`;

                // æ“ä½œæŒ‰éˆ•
                content += `<div class="flex flex-wrap justify-end gap-2 text-sm">`;
                if (!task.completed) {
                    content += `<button onclick="completeTask('${task.id}')"
                                    class="bg-green-500 text-white font-bold py-1 px-3 rounded-full shadow-sm hover:bg-green-600 transition-colors duration-200">
                                    <i class="fas fa-check"></i> å®Œæˆ
                                </button>`;
                    content += `<button onclick="editTask('${task.id}', '${task.text.replace(/'/g, "\\'")}')"
                                    class="bg-blue-500 text-white font-bold py-1 px-3 rounded-full shadow-sm hover:bg-blue-600 transition-colors duration-200">
                                    <i class="fas fa-edit"></i> ç·¨è¼¯
                                </button>`;
                    content += `<button onclick="copyTask('${task.id}')"
                                    class="bg-yellow-500 text-white font-bold py-1 px-3 rounded-full shadow-sm hover:bg-yellow-600 transition-colors duration-200">
                                    <i class="fas fa-copy"></i> è¤‡è£½
                                </button>`;
                } else {
                    content += `<span class="text-sm font-bold text-green-500">å·²å®Œæˆ ğŸ‰</span>`;
                }
                content += `<button onclick="deleteTask('${task.id}')"
                                class="bg-red-500 text-white font-bold py-1 px-3 rounded-full shadow-sm hover:bg-red-600 transition-colors duration-200">
                                <i class="fas fa-trash"></i> åˆªé™¤
                            </button>`;
                content += `</div>`;
                
                taskCard.innerHTML = content;
                taskList.appendChild(taskCard);
            });

            // åˆå§‹åŒ–æ‹–æ›³æ’åºåŠŸèƒ½
            new Sortable(taskList, {
                animation: 150,
                ghostClass: 'sortable-ghost',
                onEnd: async (evt) => {
                    // é‡æ–°æ’åˆ— tasks é™£åˆ—
                    const movedItem = tasks.splice(evt.oldIndex, 1)[0];
                    tasks.splice(evt.newIndex, 0, movedItem);

                    // æ›´æ–° Firestore ä¸­çš„ order
                    for (let i = 0; i < tasks.length; i++) {
                        const taskId = tasks[i].id;
                        const taskDocRef = doc(db, `artifacts/${appId}/users/${userId}/tasks`, taskId);
                        await updateDoc(taskDocRef, { order: i });
                    }
                }
            });
        }
        
        // --- ä»»å‹™æ“ä½œå‡½å¼ ---
        // å®Œæˆä»»å‹™
        window.completeTask = async (taskId) => {
            const taskDocRef = doc(db, `artifacts/${appId}/users/${userId}/tasks`, taskId);
            await updateDoc(taskDocRef, { completed: true });
            
            const prompts = [
                `ç‚ºä¸€å€‹å°å­¸ä¸€å¹´ç´šçš„å­¸ç”Ÿï¼Œåœ¨ä»–å®Œæˆä¸€é …ä»»å‹™å¾Œï¼Œç”Ÿæˆä¸€å¥ç°¡çŸ­ã€å……æ»¿è®šç¾èˆ‡é¼“å‹µçš„è©±èªã€‚`,
                `ç•¶å°å­¸ç”Ÿå®Œæˆå­¸ç¿’ä»»å‹™å¾Œï¼Œç”Ÿæˆä¸€å¥æœ‰è¶£ä¸”èƒ½è®“ä»–æ„Ÿåˆ°é©•å‚²çš„é¼“å‹µå¥ã€‚`,
                `çµ¦å°å­¸ä¸€å¹´ç´šå­¸ç”Ÿä¸€å¥æº«æš–åˆå……æ»¿èƒ½é‡çš„é¼“å‹µè©±èªï¼Œè®“ä»–çŸ¥é“è‡ªå·±å¾ˆæ£’ã€‚`
            ];
            const randomPrompt = prompts[Math.floor(Math.random() * prompts.length)];
            const message = await getGeminiResponse(randomPrompt);
            messageText.textContent = message.replace(/["'ã€Œã€]/g, '');
            messageBox.classList.remove('hidden');
        };

        // åˆªé™¤ä»»å‹™
        window.deleteTask = async (taskId) => {
            if (confirm("ç¢ºå®šè¦åˆªé™¤é€™é …ä»»å‹™å—ï¼Ÿ")) { // ä½¿ç”¨ confirm æ›¿ä»£è‡ªå®šç¾© Modal
                const taskDocRef = doc(db, `artifacts/${appId}/users/${userId}/tasks`, taskId);
                await deleteDoc(taskDocRef);
                messageBox.classList.add('hidden');
            }
        };

        // è¤‡è£½ä»»å‹™
        window.copyTask = async (taskId) => {
            const originalTask = tasks.find(t => t.id === taskId);
            if (originalTask) {
                const newTask = {
                    text: `${originalTask.text} (è¤‡è£½)`,
                    date: selectedDate,
                    completed: false,
                    order: tasks.length 
                };
                const tasksCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/tasks`);
                await addDoc(tasksCollectionRef, newTask);
                messageBox.classList.add('hidden');
            }
        };

        // ç·¨è¼¯ä»»å‹™
        window.editTask = (taskId, taskText) => {
            editingTaskId = taskId;
            editTaskInput.value = taskText;
            editModal.classList.remove('hidden');
        };

        saveEditBtn.addEventListener('click', async () => {
            if (editingTaskId) {
                const taskDocRef = doc(db, `artifacts/${appId}/users/${userId}/tasks`, editingTaskId);
                await updateDoc(taskDocRef, { text: editTaskInput.value });
                editModal.classList.add('hidden');
                editingTaskId = null;
            }
        });

        cancelEditBtn.addEventListener('click', () => {
            editModal.classList.add('hidden');
            editingTaskId = null;
        });

        // æ–°å¢ä»»å‹™
        addTaskBtn.addEventListener('click', async () => {
            const taskText = taskInput.value.trim();
            if (taskText && db && userId) {
                const tasksCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/tasks`);
                const newTask = {
                    text: taskText,
                    date: selectedDate,
                    completed: false,
                    order: tasks.length 
                };
                await addDoc(tasksCollectionRef, newTask);
                taskInput.value = '';
                messageBox.classList.add('hidden');
            }
        });

        // æ¯æœˆç¸½çµ
        monthlySummaryBtn.addEventListener('click', async () => {
            if (!db || !userId) return;

            loadingOverlay.classList.remove('hidden');
            summaryModal.classList.remove('hidden');
            summaryContent.innerHTML = `<p class="text-center text-gray-400">æ­£åœ¨ç”Ÿæˆä¸Šå€‹æœˆçš„å­¸ç¿’ç¸½çµ...</p>`;

            const currentDate = new Date();
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth(); // 0-11
            const lastMonth = month === 0 ? 12 : month;
            const lastMonthYear = month === 0 ? year - 1 : year;
            
            const startDate = new Date(lastMonthYear, lastMonth - 1, 1).toISOString().split('T')[0];
            const endDate = new Date(lastMonthYear, lastMonth, 0).toISOString().split('T')[0];

            // å–å¾—ä¸Šå€‹æœˆçš„ä»»å‹™
            const tasksCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/tasks`);
            const allTasksSnapshot = await getDocs(tasksCollectionRef);
            let lastMonthTasks = [];
            let lastMonthCompletedCount = 0;
            allTasksSnapshot.forEach(doc => {
                const task = doc.data();
                if (task.date >= startDate && task.date <= endDate) {
                    lastMonthTasks.push(task);
                    if (task.completed) lastMonthCompletedCount++;
                }
            });

            // å‘¼å« Gemini é€²è¡Œç¸½çµ
            const summaryPrompt = `
                ç‚ºä¸€å€‹å°å­¸ä¸€å¹´ç´šçš„å­¸ç”Ÿï¼Œæ ¹æ“šä»¥ä¸‹ä¸Šå€‹æœˆçš„å­¸ç¿’ä»»å‹™å’Œå®Œæˆç‹€æ³ï¼Œç”Ÿæˆä¸€ä»½ç°¡çŸ­ã€é¼“å‹µä¸”æœ‰è¶£çš„ç¸½çµå ±å‘Šã€‚
                ç¸½çµå ±å‘Šæ‡‰åŒ…å«ï¼š
                1. ç¸½çµä¸Šå€‹æœˆçš„åŠªåŠ›å’Œæˆå°±ã€‚
                2. æåˆ°å®Œæˆçš„ä»»å‹™ç¸½æ•¸ (${lastMonthCompletedCount} å€‹)ã€‚
                3. ç”¨ä¸€å€‹å¯æ„›çš„æ¯”å–»ä¾†ç¨±è®šä»–ã€‚
                4. é¼“å‹µä»–é€™å€‹æœˆç¹¼çºŒåŠ æ²¹ã€‚
                
                ä¸Šå€‹æœˆçš„ä»»å‹™æ¸…å–®: ${JSON.stringify(lastMonthTasks)}
            `;

            const summary = await getGeminiResponse(summaryPrompt);
            summaryContent.innerHTML = summary.replace(/["'ã€Œã€]/g, '');
            loadingOverlay.classList.add('hidden');
        });

        closeSummaryBtn.addEventListener('click', () => {
            summaryModal.classList.add('hidden');
        });

    </script>
</body>
</html>
